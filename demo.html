<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Meme æ¦‚ç‡åè®® Demo</title>

  <!-- Web3Modal Core -->
  <script src="https://unpkg.com/@web3modal/core@2.5.0/dist/index.js"></script>
  <script src="https://unpkg.com/@web3modal/html@2.5.0/dist/index.js"></script>
  <script src="https://unpkg.com/@walletconnect/web3-provider@1.8.0/dist/umd/index.min.js"></script>

  <!-- Ethers.js -->
  <script src="https://cdn.ethers.io/lib/ethers-5.7.umd.min.js"></script>

  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      padding: 20px;
      background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
      color: #fff;
      margin: 0;
      min-height: 100vh;
    }
    .container {
      max-width: 800px;
      margin: 0 auto;
    }
    h1 {
      text-align: center;
      margin-bottom: 10px;
      font-size: 2.5em;
      background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }
    .subtitle {
      text-align: center;
      color: #8892b0;
      margin-bottom: 30px;
    }
    .section {
      background: rgba(255, 255, 255, 0.05);
      backdrop-filter: blur(10px);
      border-radius: 16px;
      padding: 20px;
      margin: 20px 0;
      border: 1px solid rgba(255, 255, 255, 0.1);
    }
    h3 {
      margin-top: 0;
      color: #667eea;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    button {
      padding: 12px 24px;
      margin: 5px;
      cursor: pointer;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border: none;
      color: white;
      border-radius: 8px;
      font-weight: 600;
      transition: transform 0.2s, box-shadow 0.2s;
    }
    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
    }
    button:disabled {
      background: #4a5568;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }
    button.secondary {
      background: rgba(255, 255, 255, 0.1);
    }
    input, select {
      padding: 12px;
      margin: 5px;
      width: 250px;
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.2);
      color: white;
      border-radius: 8px;
      font-size: 14px;
    }
    input:focus, select:focus {
      outline: none;
      border-color: #667eea;
      background: rgba(255, 255, 255, 0.15);
    }
    #logs {
      height: 300px;
      overflow-y: scroll;
      background: rgba(0, 0, 0, 0.3);
      padding: 15px;
      border-radius: 8px;
      font-family: 'Monaco', 'Consolas', monospace;
      font-size: 12px;
      border: 1px solid rgba(255, 255, 255, 0.1);
    }
    .log {
      margin: 3px 0;
      padding: 4px 8px;
      border-radius: 4px;
    }
    .log.green { background: rgba(16, 185, 129, 0.2); color: #10b981; }
    .log.red { background: rgba(239, 68, 68, 0.2); color: #ef4444; }
    .log.yellow { background: rgba(245, 158, 11, 0.2); color: #f59e0b; }
    .log.cyan { background: rgba(6, 182, 212, 0.2); color: #06b6d4; }
    .info-box {
      background: rgba(102, 126, 234, 0.1);
      padding: 15px;
      border-radius: 8px;
      margin-top: 10px;
      border-left: 4px solid #667eea;
    }
    .success { color: #10b981; }
    .warning { color: #f59e0b; }
    #price {
      font-size: 32px;
      font-weight: bold;
      text-align: center;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }
    pre {
      background: rgba(0, 0, 0, 0.3);
      padding: 15px;
      border-radius: 8px;
      overflow-x: auto;
      font-size: 12px;
    }

    /* Web3Modal Button Customization */
    .w3m-button {
      width: 100% !important;
      padding: 15px !important;
      font-size: 16px !important;
    }

    /* Loading Animation */
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }
    .pulse {
      animation: pulse 1.5s ease-in-out infinite;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ² Meme æ¦‚ç‡åè®® Demo</h1>
    <p class="subtitle">Powered by Web3Modal + Base Sepolia</p>

    <!-- 1. é’±åŒ…è¿æ¥ -->
    <div class="section">
      <h3>ğŸ“± 1. è¿æ¥é’±åŒ…</h3>
      <button id="connectBtn" onclick="handleConnectClick()" style="width: 100%; padding: 15px; font-size: 16px;">
        ğŸ”Œ è¿æ¥é’±åŒ…
      </button>
      <div id="walletInfo"></div>
    </div>

    <!-- 2. WebSocket çŠ¶æ€ -->
    <div class="section">
      <h3>ğŸ”— 2. å®æ—¶è¿æ¥çŠ¶æ€</h3>
      <div id="wsStatus" class="warning">æœªè¿æ¥</div>
      <div id="blockInfo"></div>
    </div>

    <!-- 3. åˆ›å»ºå¸‚åœº -->
    <div class="section">
      <h3>ğŸ“ 3. åˆ›å»ºå¸‚åœº</h3>
      <input id="question" placeholder="é—®é¢˜: ç‹—ç‹—å¸å¹´åº•èƒ½åˆ° $1?">
      <input id="duration" type="number" placeholder="å¤©æ•°" value="7">
      <button onclick="createMarket()">åˆ›å»ºå¸‚åœº</button>
    </div>

    <!-- 4. äº¤æ˜“ -->
    <div class="section">
      <h3>ğŸ’± 4. äº¤æ˜“ YES/NO</h3>
      <select id="side">
        <option value="YES">ä¹° YES</option>
        <option value="NO">ä¹° NO</option>
      </select>
      <input id="amount" type="number" placeholder="é‡‘é¢ (USDC)" value="10">
      <button onclick="trade()">äº¤æ˜“</button>
    </div>

    <!-- 5. å®æ—¶ä»·æ ¼ -->
    <div class="section">
      <h3>ğŸ“Š 5. å®æ—¶ä»·æ ¼</h3>
      <div id="price">YES: -- | NO: --</div>
      <p style="text-align: center; color: #8892b0; font-size: 14px; margin-top: 10px;">
        ä»·æ ¼ä¼šéšæ–°åŒºå—å®æ—¶æ›´æ–°
      </p>
    </div>

    <!-- 6. æœ¬åœ°è®°å½• -->
    <div class="section">
      <h3>ğŸ’¾ 6. æœ¬åœ°è®°å½•</h3>
      <button onclick="showHistory()">æŸ¥çœ‹å†å²</button>
      <button class="secondary" onclick="clearHistory()">æ¸…ç©ºå†å²</button>
      <pre id="history"></pre>
    </div>

    <!-- 7. æµ‹è¯•æŠ¥å‘Š -->
    <div class="section">
      <h3>ğŸ§ª 7. è‡ªåŠ¨åŒ–æµ‹è¯•</h3>
      <div id="testReport" class="info-box">
        <p>ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®è¿è¡Œå®Œæ•´æµ‹è¯•</p>
      </div>
      <button onclick="runTests()">è¿è¡Œå®Œæ•´æµ‹è¯•</button>
    </div>

    <!-- æ—¥å¿— -->
    <div class="section">
      <h3>ğŸ“‹ æ“ä½œæ—¥å¿—</h3>
      <div id="logs"></div>
    </div>
  </div>

  <script>
    // ==================== é…ç½® ====================
    const CONFIG = {
      CHAIN_ID: 84532,
      RPC_URL: 'https://sepolia.base.org',
      WS_URL: 'wss://sepolia.base.org',
    };

    let provider, signer, address, chainId;
    let wsProvider;
    let testResults = [];
    let isConnected = false;

    // ==================== æ—¥å¿—å·¥å…· ====================
    function log(msg, type = 'normal') {
      const logs = document.getElementById('logs');
      const div = document.createElement('div');
      div.className = `log ${type}`;
      const time = new Date().toLocaleTimeString();
      div.textContent = `[${time}] ${msg}`;
      logs.appendChild(div);
      logs.scrollTop = logs.scrollHeight;
      console.log(`[${type.toUpperCase()}] ${msg}`);
    }

    // ==================== Web3Modal é…ç½® ====================
    const web3modal = new Web3Modal.default({
      walletConnectVersion: 2,
      projectId: 'a0c1c0e0f0e0f0e0f0e0f0e0f0e0f0e0', // ä¸´æ—¶ IDï¼Œå®é™…éœ€è¦æ³¨å†Œ
      theme: 'dark',
      themeVariables: {
        '--w3m-z-index': 9999
      },
      featuredWalletIds: [
        'c57ca95b47569778a828d19178114f4db188b89b763c899ba0be1ed6a809a3f2', // MetaMask
        'fd20dc426fb3e66d80f019a36bf0e7943a554c3f5dff30fbdf5a2f66459fc7f0', // Trust Wallet
        '4622f2f994d1be8c1c4e04f91a3f9183d9ae8bdd99da384b4e1eb7aa8764e1f1', // Coinbase Wallet
      ]
    });

    // ==================== åˆå§‹åŒ– Web3Modal ====================
    async function initWeb3Modal() {
      try {
        log('ğŸ”§ åˆå§‹åŒ– Web3Modal...', 'cyan');

        // æ£€æŸ¥æ˜¯å¦æœ‰è‡ªåŠ¨è¿æ¥çš„ä¼šè¯
        if (window.ethereum && window.ethereum.selectedAddress) {
          log('âœ“ æ£€æµ‹åˆ°å·²è¿æ¥çš„é’±åŒ…', 'green');
          await connectExistingWallet();
        } else {
          log('ğŸ’¡ è¯·ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®è¿æ¥é’±åŒ…', 'yellow');
        }

        // ç›‘å¬è´¦æˆ·å˜åŒ–
        if (window.ethereum) {
          window.ethereum.on('accountsChanged', handleAccountsChanged);
          window.ethereum.on('chainChanged', handleChainChanged);
        }
      } catch (e) {
        log(`âŒ åˆå§‹åŒ–å¤±è´¥: ${e.message}`, 'red');
      }
    }

    // ==================== è¿æ¥å·²æœ‰é’±åŒ… ====================
    async function connectExistingWallet() {
      try {
        provider = new ethers.providers.Web3Provider(window.ethereum);
        signer = provider.getSigner();
        address = await signer.getAddress();
        const network = await provider.getNetwork();
        chainId = network.chainId;

        await updateWalletUI();

        // å¦‚æœæ˜¯æ­£ç¡®çš„ç½‘ç»œï¼Œå¯åŠ¨ WebSocket
        if (chainId === CONFIG.CHAIN_ID) {
          await startWebSocket();
        }

        isConnected = true;
        return true;
      } catch (e) {
        log(`âŒ è¿æ¥å¤±è´¥: ${e.message}`, 'red');
        return false;
      }
    }

    // ==================== å¤„ç†è¿æ¥æŒ‰é’®ç‚¹å‡» ====================
    async function handleConnectClick() {
      const btn = document.getElementById('connectBtn');

      // å¦‚æœå·²ç»è¿æ¥ï¼Œä¸åšä»»ä½•äº‹
      if (isConnected) {
        return;
      }

      btn.disabled = true;
      btn.innerHTML = '<span class="pulse">ğŸ”„ è¿æ¥ä¸­...</span>';

      // å°è¯•ä½¿ç”¨ Web3Modal
      try {
        if (typeof Web3Modal !== 'undefined' && Web3Modal.default) {
          log('ğŸ”¹ æ‰“å¼€ Web3Modal...', 'yellow');
          const instance = await web3modal.connect();
          provider = new ethers.providers.Web3Provider(instance);
          signer = provider.getSigner();
          address = await signer.getAddress();
          const network = await provider.getNetwork();
          chainId = network.chainId;
          isConnected = true;
          await updateWalletUI();
          if (chainId === CONFIG.CHAIN_ID) {
            await startWebSocket();
          }
        } else {
          throw new Error('Web3Modal not available');
        }
      } catch (e) {
        // Web3Modal å¤±è´¥ï¼Œå›é€€åˆ°ç›´æ¥è¿æ¥
        log('âš ï¸ Web3Modal ä¸å¯ç”¨ï¼Œä½¿ç”¨ç›´æ¥è¿æ¥', 'yellow');
        await connectWalletDirect();
      }

      if (!isConnected) {
        btn.disabled = false;
        btn.innerHTML = 'ğŸ”Œ è¿æ¥é’±åŒ…';
      }
    }

    // ==================== ç›´æ¥è¿æ¥é’±åŒ… ====================
    async function connectWalletDirect() {
      const btn = document.getElementById('connectBtn');

      try {
        if (typeof window.ethereum === 'undefined') {
          throw new Error('è¯·å®‰è£… MetaMask æˆ–å…¶ä»– Web3 é’±åŒ…');
        }

        log('ğŸ”¹ è¯·æ±‚é’±åŒ…è¿æ¥...', 'yellow');
        btn.innerHTML = '<span class="pulse">ğŸ”„ è¯·åœ¨é’±åŒ…ä¸­ç¡®è®¤...</span>';

        const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });

        if (!accounts || accounts.length === 0) {
          throw new Error('æœªè·å–åˆ°è´¦æˆ·');
        }

        provider = new ethers.providers.Web3Provider(window.ethereum);
        signer = provider.getSigner();
        address = await signer.getAddress();
        const network = await provider.getNetwork();
        chainId = network.chainId;
        isConnected = true;

        log('âœ“ é’±åŒ…å·²è¿æ¥', 'green');
        await updateWalletUI();

        if (chainId === CONFIG.CHAIN_ID) {
          await startWebSocket();
        }
      } catch (e) {
        if (e.code === 4001) {
          log('âŒ ç”¨æˆ·æ‹’ç»è¿æ¥', 'red');
        } else {
          log(`âŒ è¿æ¥å¤±è´¥: ${e.message}`, 'red');
        }
        isConnected = false;
      }
    }

    // ==================== æ‰‹åŠ¨è¿æ¥é’±åŒ… ====================
    async function connectWallet() {
      try {
        log('ğŸ”¹ æ‰“å¼€é’±åŒ…é€‰æ‹©å™¨...', 'yellow');

        const instance = await web3modal.connect();
        provider = new ethers.providers.Web3Provider(instance);
        signer = provider.getSigner();
        address = await signer.getAddress();
        const network = await provider.getNetwork();
        chainId = network.chainId;

        log('âœ“ é’±åŒ…å·²è¿æ¥', 'green');
        await updateWalletUI();

        if (chainId === CONFIG.CHAIN_ID) {
          await startWebSocket();
        }

        isConnected = true;
        return true;
      } catch (e) {
        if (e.message !== 'User closed modal') {
          log(`âŒ è¿æ¥å–æ¶ˆ: ${e.message}`, 'red');
        }
        return false;
      }
    }

    // ==================== æ›´æ–°é’±åŒ… UI ====================
    async function updateWalletUI() {
      const btn = document.getElementById('connectBtn');
      const balance = await signer.getBalance();
      const balanceEth = parseFloat(ethers.utils.formatEther(balance)).toFixed(4);
      const networkName = chainId === 84532 ? 'Base Sepolia âœ…' : `Chain ${chainId} âš ï¸`;
      const networkColor = chainId === 84532 ? '#10b981' : '#f59e0b';

      // æ›´æ–°æŒ‰é’®çŠ¶æ€
      btn.innerHTML = 'âœ… å·²è¿æ¥';
      btn.style.background = '#10b981';
      btn.disabled = true;

      const infoDiv = document.getElementById('walletInfo');
      infoDiv.innerHTML = `
        <div style="background: rgba(102, 126, 234, 0.1); padding: 15px; border-radius: 12px; margin-top: 15px; border: 1px solid rgba(102, 126, 234, 0.3);">
          <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
            <span style="font-size: 24px;">âœ…</span>
            <span style="color: #10b981; font-size: 18px; font-weight: 600;">å·²è¿æ¥</span>
          </div>
          <p style="margin: 8px 0;"><strong>åœ°å€:</strong> <span style="color: #8892b0; font-family: monospace;">${address.slice(0, 10)}...${address.slice(-8)}</span></p>
          <p style="margin: 8px 0;"><strong>ç½‘ç»œ:</strong> <span style="color: ${networkColor};">${networkName}</span></p>
          <p style="margin: 8px 0;"><strong>ä½™é¢:</strong> <span style="color: #8892b0;">${balanceEth} ETH</span></p>
          ${chainId !== CONFIG.CHAIN_ID ? `
            <div style="background: rgba(245, 158, 11, 0.1); padding: 10px; border-radius: 8px; margin-top: 10px; border: 1px solid rgba(245, 158, 11, 0.3);">
              <p style="color: #f59e0b; margin: 0;">âš ï¸ è¯·åˆ‡æ¢åˆ° Base Sepolia (Chain ID: 84532)</p>
            </div>
          ` : ''}
        </div>
      `;

      log(`âœ“ é’±åŒ…: ${address.slice(0, 6)}...${address.slice(-4)}`, 'green');
      log(`âœ“ ç½‘ç»œ: ${networkName}`, chainId === 84532 ? 'green' : 'yellow');
      log(`âœ“ ä½™é¢: ${balanceEth} ETH`, 'cyan');
    }

    // ==================== è´¦æˆ·å˜åŒ–å¤„ç† ====================
    function handleAccountsChanged(accounts) {
      if (accounts.length === 0) {
        log('âš ï¸ é’±åŒ…å·²æ–­å¼€', 'yellow');
        location.reload();
      } else {
        log('ğŸ”„ è´¦æˆ·å·²åˆ‡æ¢', 'yellow');
        location.reload();
      }
    }

    function handleChainChanged() {
      log('ğŸ”„ ç½‘ç»œå·²åˆ‡æ¢', 'yellow');
      location.reload();
    }

    // ==================== WebSocket ====================
    async function startWebSocket() {
      try {
        log('ğŸ”¹ è¿æ¥ WebSocket...', 'yellow');

        wsProvider = new ethers.providers.WebSocketProvider(CONFIG.WS_URL);

        wsProvider.on('block', (blockNumber) => {
          document.getElementById('blockInfo').innerHTML =
            `<p style="color: #10b981; margin: 10px 0;">ğŸ“¦ å½“å‰åŒºå—: ${blockNumber}</p>`;
          log(`ğŸ“¦ æ–°åŒºå—: ${blockNumber}`, 'cyan');
          updateSimulatedPrice();
        });

        document.getElementById('wsStatus').innerHTML =
          '<p style="color: #10b981; margin: 10px 0;">âœ… WebSocket å·²è¿æ¥</p>';
        log('âœ… WebSocket å·²è¿æ¥', 'green');

        return true;
      } catch (e) {
        document.getElementById('wsStatus').innerHTML =
          `<p style="color: #ef4444; margin: 10px 0;">âŒ è¿æ¥å¤±è´¥: ${e.message}</p>`;
        log(`âŒ WebSocket å¤±è´¥: ${e.message}`, 'red');
        return false;
      }
    }

    // ==================== æ¨¡æ‹Ÿä»·æ ¼æ›´æ–° ====================
    function updateSimulatedPrice() {
      const yesPrice = (0.3 + Math.random() * 0.4).toFixed(2);
      const noPrice = (1 - yesPrice).toFixed(2);
      document.getElementById('price').innerHTML = `YES: $${yesPrice} | NO: $${noPrice}`;
    }

    // ==================== åˆ›å»ºå¸‚åœº ====================
    async function createMarket() {
      const question = document.getElementById('question').value;
      const duration = document.getElementById('duration').value;

      if (!question) {
        log('âŒ è¯·è¾“å…¥é—®é¢˜', 'red');
        return;
      }

      log('ğŸ”¹ åˆ›å»ºå¸‚åœº...', 'yellow');
      log(`é—®é¢˜: ${question}`, 'cyan');
      log(`æ—¶é•¿: ${duration} å¤©`, 'cyan');

      await new Promise(r => setTimeout(r, 1000));

      const marketId = 'MKT-' + Date.now();
      log(`âœ… å¸‚åœºåˆ›å»ºæˆåŠŸ! ID: ${marketId}`, 'green');

      saveToLocal('markets', { id: marketId, question, duration, time: Date.now() });
      return marketId;
    }

    // ==================== äº¤æ˜“ ====================
    async function trade() {
      const side = document.getElementById('side').value;
      const amount = document.getElementById('amount').value;

      if (!amount || amount <= 0) {
        log('âŒ è¯·è¾“å…¥æœ‰æ•ˆé‡‘é¢', 'red');
        return;
      }

      log(`ğŸ”¹ äº¤æ˜“ ${side} ${amount} USDC...`, 'yellow');
      await new Promise(r => setTimeout(r, 800));

      const price = '0.50';
      log(`âœ… äº¤æ˜“æˆåŠŸ! ${side} ${amount} @ $${price}`, 'green');

      saveToLocal('trades', { side, amount, price, time: Date.now() });
      return true;
    }

    // ==================== æœ¬åœ°å­˜å‚¨ ====================
    function saveToLocal(key, data) {
      const history = JSON.parse(localStorage.getItem(key) || '[]');
      history.push(data);
      localStorage.setItem(key, JSON.stringify(history));
      log(`ğŸ’¾ å·²ä¿å­˜åˆ° ${key}`, 'cyan');
    }

    function showHistory() {
      const trades = JSON.parse(localStorage.getItem('trades') || '[]');
      const markets = JSON.parse(localStorage.getItem('markets') || '[]');

      const output = {
        å¸‚åœºæ•°é‡: markets.length,
        äº¤æ˜“æ•°é‡: trades.length,
        å¸‚åœº: markets,
        äº¤æ˜“: trades
      };

      document.getElementById('history').textContent = JSON.stringify(output, null, 2);
      log(`ğŸ“Š å†å²: ${markets.length} å¸‚åœº, ${trades.length} äº¤æ˜“`, 'cyan');
    }

    function clearHistory() {
      localStorage.clear();
      log('ğŸ—‘ï¸ å·²æ¸…ç©ºå†å²', 'yellow');
      showHistory();
    }

    // ==================== æµ‹è¯•å¥—ä»¶ ====================
    async function runTests() {
      const report = document.getElementById('testReport');
      report.innerHTML = '<p class="pulse" style="color: #f59e0b;">ğŸ”¹ æµ‹è¯•è¿è¡Œä¸­...</p>';
      log('ğŸ§ª å¼€å§‹è¿è¡Œæµ‹è¯•å¥—ä»¶...', 'yellow');

      testResults = [];

      await testLocalStorage();
      await testCreateMarket();
      await testTrade();
      await testDataPersistence();

      const passed = testResults.filter(r => r.status === 'PASS').length;
      const failed = testResults.filter(r => r.status === 'FAIL').length;

      const reportHtml = `
        <h4 style="color: #667eea; margin-bottom: 10px;">æµ‹è¯•ç»“æœ</h4>
        <p style="color: #10b981;">âœ… é€šè¿‡: ${passed}</p>
        <p style="color: #ef4444;">âŒ å¤±è´¥: ${failed}</p>
        <hr style="border-color: rgba(255,255,255,0.1); margin: 15px 0;">
        <pre style="background: rgba(0,0,0,0.3); padding: 10px; border-radius: 8px;">
${testResults.map(r => `[${r.status}] ${r.name}: ${r.message}`).join('\n')}
        </pre>
      `;

      report.innerHTML = reportHtml;

      if (failed === 0) {
        log(`âœ… æ‰€æœ‰æµ‹è¯•é€šè¿‡! (${passed}/${testResults.length})`, 'green');
      } else {
        log(`âš ï¸ æµ‹è¯•å®Œæˆ: ${passed} é€šè¿‡, ${failed} å¤±è´¥`, 'yellow');
      }
    }

    function addTestResult(name, status, message) {
      testResults.push({ name, status, message });
      const icon = status === 'PASS' ? 'âœ…' : 'âŒ';
      const color = status === 'PASS' ? 'green' : 'red';
      log(`  ${icon} ${name}: ${message}`, color);
    }

    async function testLocalStorage() {
      try {
        localStorage.setItem('test_key', 'test_value');
        const value = localStorage.getItem('test_key');
        if (value === 'test_value') {
          addTestResult('LocalStorage', 'PASS', 'æ­£å¸¸å·¥ä½œ');
        } else {
          addTestResult('LocalStorage', 'FAIL', 'å€¼ä¸åŒ¹é…');
        }
        localStorage.removeItem('test_key');
      } catch (e) {
        addTestResult('LocalStorage', 'FAIL', e.message);
      }
    }

    async function testCreateMarket() {
      try {
        const testQuestion = 'Test ' + Date.now();
        localStorage.setItem('test_market', JSON.stringify({ id: 'TEST', question: testQuestion }));
        const saved = JSON.parse(localStorage.getItem('test_market'));
        addTestResult('åˆ›å»ºå¸‚åœº', 'PASS', saved.question === testQuestion ? 'æˆåŠŸ' : 'å¤±è´¥');
        localStorage.removeItem('test_market');
      } catch (e) {
        addTestResult('åˆ›å»ºå¸‚åœº', 'FAIL', e.message);
      }
    }

    async function testTrade() {
      try {
        localStorage.setItem('test_trade', JSON.stringify({ side: 'YES', amount: '100' }));
        const saved = JSON.parse(localStorage.getItem('test_trade'));
        addTestResult('äº¤æ˜“åŠŸèƒ½', 'PASS', saved.side === 'YES' ? 'æˆåŠŸ' : 'å¤±è´¥');
        localStorage.removeItem('test_trade');
      } catch (e) {
        addTestResult('äº¤æ˜“åŠŸèƒ½', 'FAIL', e.message);
      }
    }

    async function testDataPersistence() {
      try {
        saveToLocal('markets', { id: 'M1' });
        saveToLocal('trades', { side: 'YES' });
        const markets = JSON.parse(localStorage.getItem('markets') || '[]');
        const trades = JSON.parse(localStorage.getItem('trades') || '[]');
        addTestResult('æ•°æ®æŒä¹…åŒ–', 'PASS', `markets: ${markets.length}, trades: ${trades.length}`);
        localStorage.clear();
      } catch (e) {
        addTestResult('æ•°æ®æŒä¹…åŒ–', 'FAIL', e.message);
      }
    }

    // ==================== é¡µé¢åŠ è½½ ====================
    window.addEventListener('load', async () => {
      log('ğŸš€ Demo å·²å°±ç»ª', 'green');
      log('ğŸ“ ç½‘ç»œ: Base Sepolia (Chain ID: 84532)', 'cyan');
      log('ğŸ”— è·å–æµ‹è¯•å¸: https://sepoliafaucet.com', 'cyan');

      await initWeb3Modal();
    });

    // ç›‘å¬ Web3Modal çš„è¿æ¥äº‹ä»¶
    window.addEventListener('WEB3_MODAL_CONNECTED', async (e) => {
      log('âœ“ Web3Modal è¿æ¥äº‹ä»¶è§¦å‘', 'green');
      await connectExistingWallet();
    });
  </script>
</body>
</html>
