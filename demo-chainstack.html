<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Meme æ¦‚ç‡åè®® - Chainstack WebSocket</title>

  <!-- Ethers.js v6 -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.7.0/ethers.umd.min.js"></script>

  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #0f0c29 0%, #302b63 50%, #24243e 100%);
      color: #fff;
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 1000px;
      margin: 0 auto;
    }

    .header {
      text-align: center;
      padding: 30px 0;
    }

    .header h1 {
      font-size: 2.5em;
      background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      margin-bottom: 10px;
    }

    .card {
      background: rgba(255, 255, 255, 0.05);
      backdrop-filter: blur(10px);
      border-radius: 16px;
      padding: 24px;
      margin: 20px 0;
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .card h3 {
      color: #667eea;
      margin-bottom: 15px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .status-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin: 20px 0;
    }

    .status-item {
      background: rgba(0, 0, 0, 0.3);
      padding: 15px;
      border-radius: 8px;
      text-align: center;
    }

    .status-label {
      font-size: 0.85em;
      color: #8892b0;
      margin-bottom: 5px;
    }

    .status-value {
      font-size: 1.2em;
      font-weight: bold;
    }

    .status-connected { color: #10b981; }
    .status-disconnected { color: #ef4444; }
    .status-pending { color: #f59e0b; }

    button {
      padding: 12px 24px;
      margin: 5px;
      border: none;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      font-size: 14px;
    }

    .btn-primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      width: 100%;
    }

    .btn-primary:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 10px 20px rgba(102, 126, 234, 0.4);
    }

    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .wallet-info {
      background: rgba(102, 126, 234, 0.1);
      border: 1px solid rgba(102, 126, 234, 0.3);
      border-radius: 12px;
      padding: 20px;
      margin-top: 15px;
    }

    .wallet-info-row {
      display: flex;
      justify-content: space-between;
      padding: 10px 0;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    .wallet-info-row:last-child {
      border-bottom: none;
    }

    .log-container {
      background: rgba(0, 0, 0, 0.4);
      border-radius: 8px;
      padding: 15px;
      max-height: 350px;
      overflow-y: auto;
      font-family: 'Monaco', 'Consolas', monospace;
      font-size: 12px;
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .log-entry {
      padding: 4px 8px;
      margin: 2px 0;
      border-radius: 4px;
    }

    .log-info { background: rgba(6, 182, 212, 0.2); color: #06b6d4; }
    .log-success { background: rgba(16, 185, 129, 0.2); color: #10b981; }
    .log-error { background: rgba(239, 68, 68, 0.2); color: #ef4444; }
    .log-warning { background: rgba(245, 158, 11, 0.2); color: #f59e0b; }

    .loading {
      display: inline-block;
      width: 16px;
      height: 16px;
      border: 2px solid #fff;
      border-top-color: transparent;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    .pulse {
      animation: pulse 1.5s ease-in-out infinite;
    }

    .alert {
      padding: 12px 16px;
      border-radius: 8px;
      margin: 10px 0;
      border-left: 4px solid;
    }

    .alert-warning {
      background: rgba(245, 158, 11, 0.1);
      border-color: #f59e0b;
      color: #f59e0b;
      font-size: 0.9em;
    }

    .alert-success {
      background: rgba(16, 185, 129, 0.1);
      border-color: #10b981;
      color: #10b981;
    }

    pre {
      background: rgba(0, 0, 0, 0.3);
      padding: 10px;
      border-radius: 6px;
      overflow-x: auto;
      font-size: 11px;
      color: #8892b0;
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Header -->
    <div class="header">
      <h1>ğŸ² Meme æ¦‚ç‡åè®®</h1>
      <p style="color: #8892b0;">DRPC WebSocket + MetaMask é’±åŒ…è¿æ¥</p>
    </div>

    <!-- è¿æ¥çŠ¶æ€ -->
    <div class="card">
      <h3>ğŸ”— è¿æ¥çŠ¶æ€</h3>
      <div class="status-grid">
        <div class="status-item">
          <div class="status-label">é’±åŒ…è¿æ¥</div>
          <div class="status-value status-disconnected" id="walletStatus">æœªè¿æ¥</div>
        </div>
        <div class="status-item">
          <div class="status-label">DRPC WebSocket</div>
          <div class="status-value status-disconnected" id="wsStatus">æœªè¿æ¥</div>
        </div>
        <div class="status-item">
          <div class="status-label">å½“å‰åŒºå—</div>
          <div class="status-value" id="blockNumber">--</div>
        </div>
        <div class="status-item">
          <div class="status-label">ç½‘ç»œ</div>
          <div class="status-value" id="networkName">--</div>
        </div>
      </div>
    </div>

    <!-- é’±åŒ…è¿æ¥ -->
    <div class="card">
      <h3>ğŸ“± 1. é’±åŒ…è¿æ¥</h3>

      <div class="alert alert-warning">
        ğŸ’¡ <strong>æç¤º:</strong> DRPC WebSocket (wss://base-sepolia.drpc.org) ç”¨äºè¯»å–é“¾ä¸Šæ•°æ®ï¼ŒMetaMask ç”¨äºå‘é€äº¤æ˜“ã€‚
      </div>

      <button id="connectBtn" class="btn-primary" onclick="connectWallet()">
        ğŸ”Œ è¿æ¥ MetaMask é’±åŒ…
      </button>

      <div id="walletSection" style="display: none; margin-top: 20px;">
        <div class="wallet-info">
          <div class="wallet-info-row">
            <span>åœ°å€:</span>
            <span id="walletAddress" style="font-family: monospace;">--</span>
          </div>
          <div class="wallet-info-row">
            <span>ç½‘ç»œ:</span>
            <span id="walletNetwork">--</span>
          </div>
          <div class="wallet-info-row">
            <span>ETH ä½™é¢:</span>
            <span id="walletBalance">--</span>
          </div>
          <div class="wallet-info-row">
            <span>Chain ID:</span>
            <span id="chainId">--</span>
          </div>
        </div>

        <div id="networkWarning" class="alert alert-warning" style="display: none; margin-top: 15px;">
          âš ï¸ å½“å‰ç½‘ç»œä¸æ˜¯ Base Mainnetï¼Œè¯·åœ¨ MetaMask ä¸­åˆ‡æ¢
        </div>
      </div>
    </div>

    <!-- æµ‹è¯•åŠŸèƒ½ -->
    <div class="card">
      <h3>ğŸ§ª 2. åŠŸèƒ½æµ‹è¯•</h3>

      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px;">
        <button class="btn-primary" onclick="testGetBlockNumber()" id="testBlockBtn" disabled>
          ğŸ“¦ è·å–åŒºå—å·
        </button>
        <button class="btn-primary" onclick="testGetBalance()" id="testBalanceBtn" disabled>
          ğŸ’° æŸ¥è¯¢ä½™é¢
        </button>
        <button class="btn-primary" onclick="testListenBlocks()" id="testListenBtn" disabled>
          ğŸ‘‚ ç›‘å¬æ–°åŒºå—
        </button>
        <button class="btn-primary" onclick="testSendTransaction()" id="testSendBtn" disabled>
          ğŸ“¤ å‘é€äº¤æ˜“
        </button>
      </div>

      <div id="testResult" style="margin-top: 15px; display: none;">
        <pre id="testResultContent"></pre>
      </div>
    </div>

    <!-- å®æ—¶æ—¥å¿— -->
    <div class="card">
      <h3>ğŸ“‹ 3. å®æ—¶æ—¥å¿—</h3>

      <div class="log-container" id="logs"></div>

      <button onclick="clearLogs()" style="margin-top: 10px; background: rgba(255,255,255,0.1); color: white; border: 1px solid rgba(255,255,255,0.2);">
        ğŸ—‘ï¸ æ¸…ç©ºæ—¥å¿—
      </button>
    </div>
  </div>

  <script>
    // ==================== é…ç½® ====================
    const CONFIG = {
      // DRPC WebSocket ç«¯ç‚¹ (Base Sepolia æµ‹è¯•ç½‘ï¼Œæ— éœ€è®¤è¯)
      DRPC_WSS: 'wss://base-sepolia.drpc.org',
      DRPC_HTTPS: 'https://base-sepolia.drpc.org',

      // Base Sepolia æµ‹è¯•ç½‘
      CHAIN_ID: 84532,
      CHAIN_NAME: 'Base Sepolia',

      // å¤‡ç”¨ RPC
      FALLBACK_RPC: 'https://sepolia.base.org',
    };

    // å…¨å±€å˜é‡
    let walletProvider = null;      // MetaMask provider (ç”¨äºäº¤æ˜“)
    let chainstackProvider = null;  // Chainstack provider (ç”¨äºè¯»å–)
    let signer = null;
    let address = null;
    let blockListener = null;

    // ==================== æ—¥å¿—å·¥å…· ====================
    function log(msg, type = 'info') {
      const logs = document.getElementById('logs');
      const entry = document.createElement('div');
      entry.className = `log-entry log-${type}`;
      const time = new Date().toLocaleTimeString();
      entry.textContent = `[${time}] ${msg}`;
      logs.appendChild(entry);
      logs.scrollTop = logs.scrollHeight;
      console.log(`[${type.toUpperCase()}]`, msg);
    }

    function clearLogs() {
      document.getElementById('logs').innerHTML = '';
      log('æ—¥å¿—å·²æ¸…ç©º', 'info');
    }

    function showResult(content) {
      const resultDiv = document.getElementById('testResult');
      const contentDiv = document.getElementById('testResultContent');
      resultDiv.style.display = 'block';
      contentDiv.textContent = typeof content === 'object' ? JSON.stringify(content, null, 2) : content;
    }

    // ==================== 1. è¿æ¥ DRPC WebSocket ====================
    async function connectDRPC() {
      try {
        log('ğŸ”Œ è¿æ¥ DRPC WebSocket...', 'info');

        // DRPC å…¬å…±ç«¯ç‚¹ï¼Œæ— éœ€è®¤è¯
        const wsUrl = CONFIG.DRPC_WSS;

        log(`WebSocket URL: ${wsUrl}`, 'info');

        // ethers.js v6 æ–¹å¼
        chainstackProvider = new ethers.WebSocketProvider(wsUrl);

        // æµ‹è¯•è¿æ¥
        const blockNumber = await chainstackProvider.getBlockNumber();
        log(`âœ… DRPC WebSocket å·²è¿æ¥!`, 'success');
        log(`ğŸ“¦ å½“å‰åŒºå—: ${blockNumber}`, 'info');

        updateStatus('wsStatus', 'connected', 'å·²è¿æ¥');
        document.getElementById('blockNumber').textContent = blockNumber;

        // è®¾ç½®ç½‘ç»œåç§°
        document.getElementById('networkName').textContent = CONFIG.CHAIN_NAME;

        return true;
      } catch (e) {
        log(`âŒ DRPC è¿æ¥å¤±è´¥: ${e.message}`, 'error');
        log(`ğŸ”„ å°è¯•ä½¿ç”¨å¤‡ç”¨ RPC...`, 'warning');

        try {
          // å›é€€åˆ° HTTPS RPC
          chainstackProvider = new ethers.JsonRpcProvider(CONFIG.FALLBACK_RPC);
          const blockNumber = await chainstackProvider.getBlockNumber();
          log(`âœ… å¤‡ç”¨ RPC å·²è¿æ¥! å½“å‰åŒºå—: ${blockNumber}`, 'success');
          updateStatus('wsStatus', 'connected', 'å¤‡ç”¨ RPC');
          document.getElementById('blockNumber').textContent = blockNumber;
          return true;
        } catch (fallbackError) {
          log(`âŒ å¤‡ç”¨ RPC ä¹Ÿå¤±è´¥: ${fallbackError.message}`, 'error');
          updateStatus('wsStatus', 'disconnected', 'è¿æ¥å¤±è´¥');
          return false;
        }
      }
    }

    // ==================== 2. è¿æ¥ MetaMask é’±åŒ… ====================
    async function connectWallet() {
      const btn = document.getElementById('connectBtn');

      try {
        btn.disabled = true;
        btn.innerHTML = '<span class="loading"></span> è¿æ¥ä¸­...';

        // æ£€æŸ¥ MetaMask
        if (!window.ethereum) {
          throw new Error('æœªæ£€æµ‹åˆ° MetaMaskï¼Œè¯·å…ˆå®‰è£… MetaMask æ‰©å±•');
        }

        log('ğŸ“± è¯·æ±‚ MetaMask è¿æ¥...', 'info');

        // è¯·æ±‚è´¦æˆ·è®¿é—®
        await window.ethereum.request({ method: 'eth_requestAccounts' });

        // åˆ›å»º provider
        walletProvider = new ethers.BrowserProvider(window.ethereum);
        signer = await walletProvider.getSigner();
        address = await signer.getAddress();

        log(`âœ… é’±åŒ…å·²è¿æ¥: ${address.slice(0, 8)}...${address.slice(-6)}`, 'success');

        // è·å–ç½‘ç»œä¿¡æ¯
        const network = await walletProvider.getNetwork();
        const chainId = Number(network.chainId);

        log(`ğŸŒ ç½‘ç»œ: ${network.name} (Chain ID: ${chainId})`, 'info');

        // æ›´æ–° UI
        await updateWalletUI(chainId);

        // æ£€æŸ¥ç½‘ç»œ
        if (chainId !== CONFIG.CHAIN_ID) {
          log(`âš ï¸ ç½‘ç»œä¸åŒ¹é…! éœ€è¦: ${CONFIG.CHAIN_ID}, å½“å‰: ${chainId}`, 'warning');
          document.getElementById('networkWarning').style.display = 'block';
          document.getElementById('networkWarning').textContent = `âš ï¸ å½“å‰ç½‘ç»œä¸æ˜¯ Base Sepolia (éœ€è¦ Chain ID: ${CONFIG.CHAIN_ID})`;
        } else {
          log(`âœ… ç½‘ç»œæ­£ç¡®!`, 'success');
        }

        // å¯ç”¨æµ‹è¯•æŒ‰é’®
        enableTestButtons();

        updateStatus('walletStatus', 'connected', 'å·²è¿æ¥');

        // åŒæ—¶è¿æ¥ DRPC WebSocket
        await connectDRPC();

        btn.innerHTML = 'âœ… å·²è¿æ¥';

      } catch (e) {
        log(`âŒ è¿æ¥å¤±è´¥: ${e.message}`, 'error');

        if (e.code === 4001) {
          log('ç”¨æˆ·æ‹’ç»è¿æ¥', 'warning');
        }

        btn.disabled = false;
        btn.innerHTML = 'ğŸ”Œ è¿æ¥ MetaMask é’±åŒ…';
      }
    }

    async function updateWalletUI(chainId) {
      // è·å–ä½™é¢
      const balance = await walletProvider.getBalance(address);
      const balanceEth = ethers.formatEther(balance);

      // ç½‘ç»œåç§°
      const networkNames = {
        1: 'Ethereum',
        8453: 'Base Mainnet',
        84532: 'Base Sepolia',
        11155111: 'Sepolia'
      };
      const networkName = networkNames[chainId] || `Chain ${chainId}`;

      // æ›´æ–°æ˜¾ç¤º
      document.getElementById('walletSection').style.display = 'block';
      document.getElementById('walletAddress').textContent = `${address.slice(0, 10)}...${address.slice(-8)}`;
      document.getElementById('walletNetwork').textContent = networkName;
      document.getElementById('walletBalance').textContent = `${parseFloat(balanceEth).toFixed(4)} ETH`;
      document.getElementById('chainId').textContent = chainId;
      document.getElementById('networkName').textContent = networkName;

      log(`ğŸ’° ä½™é¢: ${balanceEth} ETH`, 'info');
    }

    function updateStatus(elementId, status, text) {
      const element = document.getElementById(elementId);
      element.className = `status-value status-${status}`;
      element.textContent = text;
    }

    function enableTestButtons() {
      document.getElementById('testBlockBtn').disabled = false;
      document.getElementById('testBalanceBtn').disabled = false;
      document.getElementById('testListenBtn').disabled = false;
      document.getElementById('testSendBtn').disabled = false;
    }

    // ==================== 3. æµ‹è¯•åŠŸèƒ½ ====================

    async function testGetBlockNumber() {
      try {
        log('ğŸ“¦ è·å–å½“å‰åŒºå—å·...', 'info');

        // ä¼˜å…ˆä½¿ç”¨ Chainstack
        const provider = chainstackProvider || walletProvider;
        const blockNumber = await provider.getBlockNumber();

        log(`âœ… å½“å‰åŒºå—: ${blockNumber}`, 'success');
        showResult({ blockNumber, source: chainstackProvider ? 'DRPC WebSocket' : 'MetaMask' });
        document.getElementById('blockNumber').textContent = blockNumber;

      } catch (e) {
        log(`âŒ è·å–å¤±è´¥: ${e.message}`, 'error');
      }
    }

    async function testGetBalance() {
      try {
        log('ğŸ’° æŸ¥è¯¢ä½™é¢...', 'info');

        const provider = chainstackProvider || walletProvider;
        const balance = await provider.getBalance(address);
        const balanceEth = ethers.formatEther(balance);

        log(`âœ… ä½™é¢: ${balanceEth} ETH`, 'success');
        showResult({
          address: `${address.slice(0, 10)}...${address.slice(-8)}`,
          balance: balanceEth,
          balanceWei: balance.toString()
        });

      } catch (e) {
        log(`âŒ æŸ¥è¯¢å¤±è´¥: ${e.message}`, 'error');
      }
    }

    function testListenBlocks() {
      try {
        if (blockListener) {
          // åœæ­¢ç›‘å¬
          chainstackProvider.removeAllListeners('block');
          blockListener = null;
          document.getElementById('testListenBtn').textContent = 'ğŸ‘‚ ç›‘å¬æ–°åŒºå—';
          log('â¹ï¸ å·²åœæ­¢ç›‘å¬æ–°åŒºå—', 'warning');
          return;
        }

        log('ğŸ‘‚ å¼€å§‹ç›‘å¬æ–°åŒºå—...', 'info');

        // ä½¿ç”¨ Chainstack WebSocket ç›‘å¬
        const provider = chainstackProvider || walletProvider;

        provider.on('block', (blockNumber) => {
          log(`ğŸ“¦ æ–°åŒºå—: ${blockNumber}`, 'info');
          document.getElementById('blockNumber').textContent = blockNumber;
        });

        blockListener = true;
        document.getElementById('testListenBtn').textContent = 'â¹ï¸ åœæ­¢ç›‘å¬';
        log('âœ… ç›‘å¬å·²å¯åŠ¨ï¼Œç­‰å¾…æ–°åŒºå—...', 'success');

      } catch (e) {
        log(`âŒ ç›‘å¬å¤±è´¥: ${e.message}`, 'error');
      }
    }

    async function testSendTransaction() {
      try {
        if (!signer) {
          throw new Error('è¯·å…ˆè¿æ¥é’±åŒ…');
        }

        log('ğŸ“¤ å‘é€æµ‹è¯•äº¤æ˜“...', 'info');

        // å‘é€ 0 ETH åˆ°è‡ªå·±ï¼ˆæµ‹è¯•äº¤æ˜“ï¼‰
        const tx = {
          to: address,
          value: 0
        };

        log('è¯·åœ¨ MetaMask ä¸­ç¡®è®¤äº¤æ˜“...', 'warning');

        const txResponse = await signer.sendTransaction(tx);

        log(`âœ… äº¤æ˜“å·²å‘é€! Hash: ${txResponse.hash.slice(0, 10)}...`, 'success');
        log('â³ ç­‰å¾…äº¤æ˜“ç¡®è®¤...', 'info');

        const receipt = await txResponse.wait();

        log(`âœ… äº¤æ˜“å·²ç¡®è®¤! åŒºå—: ${receipt.blockNumber}`, 'success');
        showResult({
          txHash: txResponse.hash,
          blockNumber: receipt.blockNumber,
          gasUsed: receipt.gasUsed.toString()
        });

      } catch (e) {
        log(`âŒ äº¤æ˜“å¤±è´¥: ${e.message}`, 'error');
      }
    }

    // ==================== 4. ç›‘å¬ MetaMask äº‹ä»¶ ====================
    function setupMetaMaskListeners() {
      if (window.ethereum) {
        // è´¦æˆ·å˜åŒ–
        window.ethereum.on('accountsChanged', (accounts) => {
          if (accounts.length === 0) {
            log('âš ï¸ é’±åŒ…å·²æ–­å¼€è¿æ¥', 'warning');
            location.reload();
          } else {
            log('ğŸ”„ è´¦æˆ·å·²å˜åŒ–ï¼Œé‡æ–°åŠ è½½...', 'warning');
            setTimeout(() => location.reload(), 1000);
          }
        });

        // ç½‘ç»œå˜åŒ–
        window.ethereum.on('chainChanged', () => {
          log('ğŸ”„ ç½‘ç»œå·²å˜åŒ–ï¼Œé‡æ–°åŠ è½½...', 'warning');
          setTimeout(() => location.reload(), 1000);
        });
      }
    }

    // ==================== é¡µé¢åŠ è½½ ====================
    window.addEventListener('load', () => {
      log('ğŸš€ é¡µé¢å·²åŠ è½½', 'success');
      log('ğŸ“¡ ç½‘ç»œ: Base Sepolia (Chain ID: 84532)', 'info');
      log('ğŸ”Œ WebSocket: wss://base-sepolia.drpc.org (æ— éœ€è®¤è¯)', 'info');
      log('ğŸ’¡ æç¤º: ç‚¹å‡»"è¿æ¥ MetaMask é’±åŒ…"å³å¯è‡ªåŠ¨è¿æ¥ DRPC WebSocket', 'info');

      // æ£€æŸ¥æ˜¯å¦æœ‰å·²è¿æ¥çš„é’±åŒ…
      if (window.ethereum && window.ethereum.selectedAddress) {
        log('æ£€æµ‹åˆ°å·²è¿æ¥çš„é’±åŒ…ï¼Œç‚¹å‡»è¿æ¥æŒ‰é’®åˆå§‹åŒ–...', 'info');
      }

      // è®¾ç½®ç›‘å¬å™¨
      setupMetaMaskListeners();
    });
  </script>
</body>
</html>
